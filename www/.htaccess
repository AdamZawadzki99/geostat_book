# ----------------------------------------------------------------------
# Gzip compression
# ----------------------------------------------------------------------
<IfModule mod_deflate.c>
  	# Force deflate for mangled headers developer.yahoo.com/blogs/ydn/posts/2010/12/pushing-beyond-gzipping/
	<IfModule mod_setenvif.c>
		<IfModule mod_headers.c>
			SetEnvIfNoCase ^(Accept-EncodXng|X-cept-Encoding|X{15}|~{15}|-{15})$ ^((gzip|deflate)\s*,?\s*)+|[X~-]{4,13}$ HAVE_Accept-Encoding
			RequestHeader append Accept-Encoding "gzip,deflate" env=HAVE_Accept-Encoding
		</IfModule>
	</IfModule>

	<IfModule mod_mime.c>
		AddEncoding gzip svgz
	</IfModule>

  # Compress all output labeled with one of the following MIME-types
	<IfModule mod_filter.c>
		AddOutputFilterByType DEFLATE "application/atom+xml" \
									  "application/javascript" \
									  "application/manifest+json" \
									  "application/rss+xml" \
									  "application/xml" \
									  "image/svg+xml" \
									  "image/x-icon" \
									  "text/cache-manifest" \
									  "text/css" \
									  "text/html" \
									  "text/javascript" \
									  "text/plain" \
									  "text/x-component" \
									  "text/xml"
	</IfModule>
</IfModule>

# ----------------------------------------------------------------------
# Rewrite engine rules
# ----------------------------------------------------------------------
<IfModule mod_rewrite.c>
	RewriteEngine On
	Options +FollowSymlinks
</IfModule>
<IfModule mod_rewrite.c>
	RewriteEngine On
	# Suppress 'www' at the beginning of URLs
	RewriteCond %{HTTPS} !=on
	RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
	RewriteRule ^ http://%1%{REQUEST_URI} [R=301,L]
</IfModule>

# ----------------------------------------------------------------------
# Security
# ----------------------------------------------------------------------
# "-Indexes" will have Apache block users from browsing folders without a default document
<IfModule mod_autoindex.c>
  Options -Indexes
</IfModule>
<IfModule mod_rewrite.c>
	RewriteEngine On
	# Block access to "hidden" directories or files whose names begin with a period.
	RewriteCond %{REQUEST_URI} "!(^|/)\.well-known/([^./]+./?)+$" [NC]
	RewriteCond %{SCRIPT_FILENAME} -d [OR]
	RewriteCond %{SCRIPT_FILENAME} -f
	RewriteRule "(^|/)\." - [F]
</IfModule>

# ----------------------------------------------------------------------
# Cache assets
# ----------------------------------------------------------------------
# Remove `ETags` as resources are sent with far-future expires headers.
# `FileETag None` doesn't work in all cases.
<IfModule mod_headers.c>
	Header unset ETag
</IfModule>
FileETag None
# Serve resources with far-future expires headers.
<IfModule mod_expires.c>
	ExpiresActive on
	ExpiresDefault "access plus 1 day"
		# CSS
		ExpiresByType text/css "access plus 1200 seconds"
		# Favicon (cannot be renamed!) and cursor images
		ExpiresByType image/x-icon "access plus 1 week"
		# HTML components (HTCs)
		ExpiresByType text/x-component "access plus 1 week"
		# HTML
		ExpiresByType text/html "access plus 1200 seconds"
		# JavaScript
		ExpiresByType application/javascript "access plus 1 day"
		ExpiresByType text/javascript "access plus 1 day"
		# Manifest files
		ExpiresByType text/cache-manifest "access plus 0 seconds"
		# Media files
		ExpiresByType image/gif "access plus 1 month"
		ExpiresByType image/jpeg "access plus 1 month"
		ExpiresByType image/png "access plus 1 month"
		# Web feeds
		ExpiresByType application/atom+xml "access plus 1 hour"
		ExpiresByType application/rss+xml "access plus 1 hour"
		# Web fonts
		ExpiresByType application/font-woff "access plus 1 week"
</IfModule>

# ----------------------------------------------------------------------
# others
# ----------------------------------------------------------------------

# Path to error page
ErrorDocument 404 /404.html

# Media types and character encodings
AddDefaultCharset utf-8
<IfModule mod_mime.c>
  	AddCharset utf-8 .css \
                	 .js \
                  	 .atom \
                	 .rss \
                	 .xml
	AddType application/javascript js
	AddType application/font-woff woff
	AddType application/xml atom rdf rss xml
	AddType image/x-icon cur ico
</IfModule>
