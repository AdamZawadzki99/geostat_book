
# R a dane przestrzenne {#r-a-dane-przestrzenne}

## Wprowadzenie

### Reprezentacja danych nieprzestrzennych
    
- Wektory (ang. *vector*):
    - liczbowe (ang. *integer*, *numeric*) - `c(1, 2, 3)` i `c(1.21, 3.32, 4.43)`
    - znakowe (ang. *character*) - `c("jeden", "dwa", "trzy")`
    - logiczne (ang. *logical*) - `c(TRUE, FALSE)`
    - czynnikowe (ang. *factor*) - `c("jeden", "dwa", "trzy", "jeden")`
- Ramki danych (ang. *data.frame*) - to zbiór zmiennych (kolumn) oraz obserwacji (wierszy) zawierających różne typy danych
- Macierze (ang. *matrix*)
- Listy (ang. *list*)

### Pakiety

R zawiera wiele funkcji pozwalających na przetwarzanie, wizualizację i analizowanie danych przestrzennych.
Zawarte są one w szeregu pakietów (zbiorów funkcji), między innymi:

- GIS - **sf**, **stars** **raster**, **sp**, **rgdal**, **rgeos**
- Geostatystyka - **gstat**, **geoR**, **geoRglm**

Więcej szczegółów na ten temat pakietów R służących do analizy przestrzennej można znaleźć pod adresem https://cran.r-project.org/web/views/Spatial.html.

### Reprezentacja danych przestrzennych

Dane przestrzenne mogą być reprezentowane w R poprzez szereg różnych klas obiektów z użyciem różnych pakietów R. 
Przykładowo dane wektorowe mogą być reprezentowane poprzez obiekty klasy `Spatial*` z pakietu **sp** oraz obiekty klasy `sf` z pakietu **sf**.

Wszystkie obiekty klasy `Spatial*` z pakietu **sp** zawierają tablę atrybutów oraz dwie dodatkowe informacje:
    - bounding box (`bbox`) - obwiednia - określa zasięg danych
    - CRS (`proj4string`) - układ współrzędnych
Ten pakiet definiuje klasę obiektów - sposób reprezentacji danych.
Najczęściej stosowane obiekty klasy `Spatial*` to `SpatialPointsDataFrame`, `SpatialPolygonsDataFrame` oraz `SpatialGridDataFrame`. 
Ostatnia klasa reprezentuje dane rastrowe.  
Dodatkowo ten pakiet współpracuje z pakietami **rgdal** służącym do wczytywania i zapisywania danych oraz **rgeos** służącym do przetwarzania danych przestrzennych.
W oparciu o pakiet **sp** powstało kilkaset dodatkowych pakietów R do analizy danych przestrzennych.

Pakiet **sf** to następca pakietu **sp** oparty o OGC standard Simple Features.
Łączy on możliwości zarówno pakietu **sp** jak i pakietów **rgdal** i **rgeos**.
Więkość jego funkcji zaczyna się od prefiksu `st_`.
Ten pakiet pozwala na obsługę dodatkowych typów danych wektorowych (np. poligon i multipoligon to dwie oddzielne klasy), łatwiejsze przetwarzanie danych, oraz obsługę przestrzennych baz danych takich jak PostGIS.
Pakiet **sf** jest używany przez kilkadziesiąt dodatkowych pakietów R, jednak wiele metod i funkcji nadal wymaga obiektów klasy **sp**.

Porównanie funkcji dostępnych w pakietach **sp** i **sf** można znaleźć pod adresem https://github.com/r-spatial/sf/wiki/Migrating.

Więcej o pakiecie **sf** można przeczytać w [rozdziale drugim](https://geocompr.robinlovelace.net/spatial-class.html) Geocomputation with R.

Dane rastrowe są reprezentowane między innymi poprzez klasę `SpatialGridDataFrame` z pakietu **sp**, obiekty klasy `Raster*` z pakietu **raster**, oraz klasę `stars` z pakietu **stars**.
<!-- DODAJ COŚ -->

### GDAL/OGR

- Pakiety **rgdal**, **raster** czy **sf** wykorzystują biblioteki GDAL/OGR w R do wczytywania i zapisywania danych przestrzennych
- http://www.gdal.org/
- GDAL to biblioteka zawierająca funkcje służące do odczytywania i zapisywania danych w formatach rastrowych
- OGR to biblioteka służąca to odczytywania i zapisywania danych w formatach wektorowych

### PROJ

- Pakiety **sp**, **raster**, czy **sf** używają biblioteki PROJ do określania i konwersji układów współrzędnych
- https://proj4.org/
- Dane przestrzenne powinny być zawsze powiązane z układem współrzędnych
- PROJ - to biblioteka pozwalająca na identyfikację oraz konwersję pomiędzy różnymi układami współrzędnych
- Strona http://www.spatialreference.org/ zawiera bazę danych układów współrzędnych 
- Układy współrzędnych mogą być opisywane na szereg sposobów, np poprzez:

    - Reprezentację proj4string - określa ona szereg własności układu współrzędnych
    - Kod EPSG (ang. *European Petroleum Survey Group*) - pozwala on na łatwe identyfikowanie układów współrzędnych.

- Przykładowo, układ PL 1992 może być określony jako:

`"+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"`

- ...lub też za pomocą kodu EPSG:
    
`2180`

### Układ geograficzny

- Proporcje pomiędzy współrzędną oznaczającą długość geograficzną (X) a oznaczającą szerokość geograficzną (Y) nie są równe 1:1
- Wielkość oczka siatki jest zmienna 
- Nie pozwala to na proste określanie odległości czy powierzchni
- Jednostka mapy jest abstrakcyjna
- Powyższe cechy układów geograficznych powodują, że do większości algorytmów w geostatystyce wykorzystywane są układy współrzędnych prostokątnych płaskich

### Układ współrzędnych prostokątnych płaskich

- Określane są w miarach liniowych (np. metrach)
- Proporcje między współrzędną X a Y są równe 1:1
- Wielkość oczka jest stała

### GEOS

- Pakiety **rgeos** czy **sf** używają biblioteki GEOS do wykonywania operacji przestrzennych
- http://geos.osgeo.org/
- GEOS to biblioteka pozwalająca na przetwarzanie obiektów przestrzennych
- Przykładowe funkcje tej biblioteki to tworzenie buforów, wyliczanie centroidów, określanie relacji topologicznych (np. przecina, zawiera, etc.) i wiele innych

## Import danych

R pozwala na odczytywanie danych przestrzennych z wielu formatów.
Do najpopularniejszych należą dane tekstowe z plików .csv, dane wektorowe z plików .shp, dane rastrowe z plików w formacie GeoTIFF, oraz bazy danych przestrzennych z plików .gpkg.

### Format .csv (dane punktowe)

Dane z plików tekstowych (np. .csv) można odczytać za pomocą uogólnionej funkcji `read.table()` lub też funkcji szczegółowych - `read.csv()` lub `read.csv2()`.

```{r}
dane_punktowe <- read.csv("dane/punkty.csv")
```

```{r}
head(dane_punktowe)
```

Po wczytaniu za pomocą funkcji `read.csv()`, nowy obiekt (np. `dane_punktowe`) jest reprezentowany za pomocą klasy nieprzestrzennej `data.frame`. 
Aby obiekt został przetworzony do klasy przestrzennej, konieczne jest określenie które kolumny zawierają informacje o współrzędnych.
W tym wypadku współrzędne znajduję się w kolumnach `x` oraz `y`. 
Nadanie układu współrzędnych odbywa się poprzez funkcję `st_as_sf()`.

```{r}
library(sf)
dane_punktowe_sf <- st_as_sf(dane_punktowe, coords = c("x", "y"))
dane_punktowe_sf
```

Ważne, ale nie wymagane, jest także dodanie informacji o układzie przestrzennym danych za pomocą funkcji `st_set_crs()`. 

```{r}
dane_punktowe_sf <- st_set_crs(dane_punktowe_sf, 2180)
```

Proste wizualizacje uzyskanych danych klasy przestrzennej, np. `sf`, można uzyskać za pomocą funkcji `plot()`.

```{r}
plot(dane_punktowe_sf)
```

### Dane poligonowe (formaty gisowe)

Dane wektorowe (np. GeoPackage czy ESRI Shapefile) można odczytać za pomocą funkcji `st_read()` z pakietu **sf**.
Przyjmuje ona co najmniej jeden argument - `dsn`, który określa główny plik w którym znajdują się dane. 

```{r}
library(sf)
granica_sf <- st_read(dsn = "dane/granica.gpkg")
plot(granica_sf)
```

### Rastry

Istnieje kilka sposobów odczytu danych rastrowych w R. 
Do najpopularniejszych należą funkcje `readGDAL()` z pakietu `rgdal` oraz `raster()` z pakietu **raster**.
W poniższym przykładzie użyjemy funkcji `read_stars()` z pakietu **stars**.
Należy w niej jedynie podać ścieżkę do pliku rastrowego.

```{r}
library(stars)
siatka_stars <- read_stars("dane/siatka.tif")
plot(siatka_stars)
```

## Przeglądanie danych przestrzennych

### Struktura obiektu

Podstawowe informacje o obiekcie można uzyskać poprzez wpisanie jego nazwy:

```{r}
dane_punktowe_sf
```

Obiekty `sf` są zbudowane z tabeli (data frame) wraz z dodatkową kolumną zawierającą geometrie (często nazywaną `geometry` lub `geom`) oraz szeregu atrybutów przestrzennych.
Strukturę obiektu `sf` można sprawdzić za pomocą funkcji `str()`:

```{r}
str(dane_punktowe_sf)
```

### Tabla atrybutów

Funkcja `st_drop_geometry()` pozwala na pozbycie się informacji przestrzennych i uzyskanie jedynie obiektu klasy `data.frame` zawierającego nieprzestrzenne informacje o kolejnych punktach w tym zbiorze.

```{r}
df <- st_drop_geometry(dane_punktowe_sf)
head(df)
```

### Współrzędne

Funkcja `st_coordinates()` pozwala na wydobycie współrzędnych z obiektu punktowego klasy `sf`.

```{r}
xy <- st_coordinates(dane_punktowe_sf)
head(xy)
```

### Obwiednia

Funkcja `st_bbox()` określa zasięg przestrzenny danych w jednostkach mapy.

```{r}
st_bbox(dane_punktowe_sf)
```

### Układ współrzędnych

Funkcja `st_crs()` wyświetla definicję układu współrzędnych.

```{r}
st_crs(dane_punktowe_sf)
```

## Eksport danych

### Zapisywanie danych wektorowych

R pozwala również na zapisywanie danych przestrzennych. 
W przypadku zapisu danych wektorowych za pomocą funkcji `st_write()` konieczne jest podanie ścieżki i  nazwy zapisywanego obiektu wraz z rozszerzeniem (np. `dane/granica.gpkg`).

```{r zapis_wektora, eval=FALSE}
st_write(granica, dsn = "dane/granica.gpkg")
```

### Zapisywanie danych rastrowych

Funkcja `st_write()` pozwala również na zapisywanie danych rastrowych.
Wymaga ona podania dwóch argumentów - nazwy zapisywanego obiektu (np. `siatka`) oraz ścieżki i nazwy nowego pliku wraz z rozszerzeniem (np. `dane/nowa_siatka.tif`).

```{r zapis_rastra, eval=FALSE}
st_write(siatka_stars, "dane/nowa_siatka.tif")
```

<!-- Możliwe jest także użycie szeregu dodatkowych argumentów, np.: -->
<!-- - `type` - określającego typ danych wyjściowych  -->
<!-- - `options` - pozwalającego na użycie dodatkowych opcji sterownika, np. użycie kompresji danych -->

## Wizualizacja danych 2D

Do wizualizacji danych przestrzennych w R służy co najmniej kilkanaście różnych pakietów. 
Poniżej pokazane są przykłady standardowej funkcji `plot()`.
Więcej o wizualizacji danych przestrzennych można przeczytać w rozdziale [Making maps with R](https://geocompr.robinlovelace.net/adv-map.html) książki Geocomputation with R.

### Dane punktowe

Funkcja `plot()` idealnie nadaje się do szybkiego przyjrzenia się, np. rodzajowi próbkowania danych.
Domyślnie wyświetla ona szereg map - po jeden dla każdej zmiennej:

```{r}
plot(dane_punktowe_sf)
```

Do wyświetlenia tylko geometrii (np. punktów) bez atrybutów służy funkcja `plot()` połączona z funkcją `st_geometry()`:

```{r}
plot(st_geometry(dane_punktowe_sf))
```

Aby wyświetlić tylko jedną zmienną należy ją zadeklarować poprzez nawias kwadratowy.
Poniżej można zobaczyć przykłady dla zmiennych `temp` oraz `srtm`.

```{r}
plot(dane_punktowe_sf["temp"])
```

```{r}
plot(dane_punktowe_sf["srtm"])
```

### Dane punktowe - kategorie

Nie zawsze dane mają postać ciągłych wartości - bywają one również określeniami różnych klas. 
W takich sytuacjach należy wcześniej przetworzyć typ danych do postaci kategoryzowanej (`as.factor()`).
Następnie można je wyświetlić za pomocą funkcji `plot()`.

```{r}
dane_punktowe_sf$clc <- as.factor(dane_punktowe_sf$clc)
plot(dane_punktowe_sf["clc"])
```

### Rastry

Wyświetlanie danych w formacie rastrowym może również odbyć się z użyciem funkcji `plot()`.
Domyślnie wyświetla ona szereg map - po jeden dla każdej warstwy z pliku rastrowego:

```{r}
# pierwsza zmienna
plot(siatka_stars)
```

Aby wyświetlić tylko jedną zmienną należy ją zadeklarować poprzez indeksowanie.
<!-- Opiera się to o cztery indeksy -  `[, indeksy kolumn, , ]`,  -->

```{r}
# wybrana zmienna
plot(siatka_stars[, , , 3])
```

## Zadania {#z2}

1. Wczytaj dane z pliku `punkty_ndvi.csv` i przetwórz je do postaci obiektu przestrzennego `ndvi_p`.
2. Stwórz mapę zmiennej `ndvi` z nowo utworzonego obiektu. (Dodatkowo: zapisz mapę do pliku graficznego `punkty_ndvi.png`).
3. Zapisz obiekt `ndvi_p` do formatu GeoPackage oraz do formatu ESRI Shapefile.
